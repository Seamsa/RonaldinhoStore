<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R10 Admin | Dashboard Propri√©taire</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Space+Grotesk:wght@300;400;700&display=swap" rel="stylesheet">
    
    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- BIBLIOTH√àQUES POUR CR√âER LES PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --primary: #E2A900; --dark: #000100; }
        body { background-color: white; color: var(--dark); font-family: 'Space Grotesk', sans-serif; }
        .neo-brutal-shadow { box-shadow: 8px 8px 0px 0px var(--dark); }
        .heading-font { font-family: 'Archivo Black', sans-serif; text-transform: uppercase; }
        .admin-card { border: 4px solid var(--dark); padding: 1.5rem; margin-bottom: 2rem; }
        .input-neo { border: 3px solid black; padding: 0.5rem; width: 100%; font-weight: bold; outline: none; margin-bottom: 1rem; }
        .sidebar { background: var(--dark); color: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .size-badge { background: black; color: #E2A900; padding: 2px 6px; font-size: 0.8rem; margin-right: 4px; font-weight: bold; border: 1px solid black; }
        .size-badge.low-stock { background: red; color: white; border-color: red; }
    </style>
</head>
<body class="flex min-h-screen">

    <aside class="w-64 sidebar p-6 flex flex-col border-r-4 border-black">
        <h1 class="heading-font text-2xl mb-10 text-white">R10 <span class="text-[#E2A900]">ADMIN</span></h1>
        <nav class="space-y-4">
            <button onclick="showTab('inventory')" class="w-full text-left font-bold hover:underline">üì¶ INVENTAIRE</button>
            <button onclick="showTab('orders')" class="w-full text-left font-bold hover:underline">üßæ COMMANDES</button>
            <hr class="border-gray-700">
            <a href="index.html" class="text-sm opacity-70">Voir la boutique client</a>
        </nav>
    </aside>

    <main class="flex-grow p-10">
        <section id="inventory" class="tab-content active">
            <h2 class="heading-font text-4xl mb-8">Gestion du Stock</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
                <div class="admin-card neo-brutal-shadow bg-[#E2A900]">
                    <h3 class="heading-font text-xl mb-4">Ajouter un Produit</h3>
                    
                    <label class="block font-bold">Nom du mod√®le</label>
                    <input type="text" id="p-name" class="input-neo" placeholder="Ex: R10 Gold '05">
                    
                    <label class="block font-bold">Cat√©gorie</label>
                    <select id="p-category" class="input-neo bg-white">
                        <option value="sneakers">OWN THE STREETS</option>
                        <option value="street">DOMINATE THE FIELD</option>
                    </select>

                    <label class="block font-bold">Prix (DA)</label>
                    <input type="number" id="p-price" class="input-neo" placeholder="18000">
                    
                    <label class="block font-bold">Stock par Taille (Format: 40:5, 41:2)</label>
                    <input type="text" id="p-stock-data" class="input-neo" placeholder="Ex: 40:5, 41:3, 42:1">
                    <p class="text-xs mb-4 font-bold opacity-70">Syntaxe : Taille:Quantit√©, Taille:Quantit√©...</p>
                    
                    <label class="block font-bold">URL Image</label>
                    <input type="text" id="p-img" class="input-neo" placeholder="Lien de la photo">
                    
                    <label class="block font-bold">Description</label>
                    <textarea id="p-desc" class="input-neo" rows="2"></textarea>
                    
                    <button type="button" onclick="addProduct()" class="w-full bg-black text-white p-3 font-black uppercase">Mettre en rayon</button>
                </div>

                <div class="lg:col-span-2">
                    <div id="admin-product-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </section>

        <section id="orders" class="tab-content">
            <h2 class="heading-font text-4xl mb-8">Commandes Re√ßues</h2>
            <div id="admin-orders-list" class="space-y-6"></div>
        </section>
    </main>

    <script>
        const ADMIN_PASSWORD = "123"; 
        const access = prompt("Acc√®s r√©serv√© au propri√©taire. Entrez le mot de passe :");
        
        if (access !== ADMIN_PASSWORD) {
            document.body.innerHTML = `
                <div class="flex flex-col items-center justify-center h-screen bg-red-100">
                    <h1 class="text-4xl font-black text-red-600 mb-4 heading-font">ACC√àS REFUS√â ‚õî</h1>
                    <p class="text-xl mb-6 font-bold">Mot de passe incorrect.</p>
                    <button onclick="location.reload()" class="bg-black text-white px-8 py-4 font-black border-4 border-black hover:bg-white hover:text-black transition-all neo-brutal-shadow">R√âESSAYER</button>
                </div>
            `;
            throw new Error("Mot de passe incorrect");
        }

        const firebaseConfig = {
            apiKey: "AIzaSyCrEd8zSy5bBape6ws3v7mvTavcZfhCKM8",
            authDomain: "r10-store-f6bb3.firebaseapp.com",
            projectId: "r10-store-f6bb3",
            storageBucket: "r10-store-f6bb3.firebasestorage.app",
            messagingSenderId: "154441292816",
            appId: "1:154441292816:web:2390d040a37d7052fdbe95"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
        }

        // --- GENERATEUR DE FACTURE PDF ---
        window.generateInvoice = async function(orderId) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // R√©cup√©rer les infos de la commande
            const orderDoc = await db.collection("orders").doc(orderId).get();
            if (!orderDoc.exists) return alert("Commande introuvable");
            const o = orderDoc.data();

            // EN-T√äTE
            doc.setFontSize(22);
            doc.setFont("helvetica", "bold");
            doc.text("RONALDINHO STORE10", 105, 20, null, null, "center");
            
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text("Sidi M'Hamed, Alger", 105, 26, null, null, "center");
            doc.text("Tel: 0557 30 03 96", 105, 31, null, null, "center");

            doc.setLineWidth(0.5);
            doc.line(20, 35, 190, 35);

            // INFOS CLIENT
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text("FACTURE", 20, 50);
            
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(`Date : ${o.date}`, 20, 56);
            doc.text(`ID Commande : #${orderId.substring(0, 8).toUpperCase()}`, 20, 61);

            doc.setFont("helvetica", "bold");
            doc.text("CLIENT :", 120, 50);
            doc.setFont("helvetica", "normal");
            doc.text(`${o.client}`, 120, 56);
            doc.text(`${o.phone}`, 120, 61);
            doc.text(`${o.wilaya}`, 120, 66);
            // D√©couper l'adresse si trop longue
            const splitAddress = doc.splitTextToSize(o.adresse, 70);
            doc.text(splitAddress, 120, 71);

            // TABLEAU DES ARTICLES
            const tableColumn = ["Article", "Taille", "Prix"];
            const tableRows = [];

            (o.items || []).forEach(item => {
                const itemData = [
                    item.name,
                    item.size,
                    `${item.price} DA`
                ];
                tableRows.push(itemData);
            });

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 90,
                theme: 'grid',
                headStyles: { fillColor: [0, 0, 0], textColor: [255, 204, 0], fontStyle: 'bold' }, // Noir et Or
                styles: { fontSize: 10, cellPadding: 3 },
            });

            // TOTAL
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text(`TOTAL √Ä PAYER : ${o.total} DA`, 190, finalY, null, null, "right");

            // PIED DE PAGE
            doc.setFontSize(10);
            doc.setFont("helvetica", "italic");
            doc.text("Merci pour votre confiance. La magie continue !", 105, finalY + 20, null, null, "center");

            // Sauvegarder le PDF
            doc.save(`Facture_R10_${o.client.replace(/\s+/g, '_')}.pdf`);
        };

        // --- FONCTIONS PRODUITS & STOCK ---
        async function addProduct() {
            const name = document.getElementById('p-name').value;
            const category = document.getElementById('p-category').value;
            const price = parseInt(document.getElementById('p-price').value);
            const stockStr = document.getElementById('p-stock-data').value;
            const img = document.getElementById('p-img').value;
            const desc = document.getElementById('p-desc').value;

            if(!name || !price || !stockStr) return alert("Champs requis !");

            const stockMap = {};
            const sizesArr = [];
            let totalStock = 0;

            try {
                const pairs = stockStr.split(',');
                pairs.forEach(p => {
                    const [size, qty] = p.split(':');
                    if(size && qty) {
                        const s = size.trim();
                        const q = parseInt(qty.trim());
                        if(!isNaN(q)) {
                            stockMap[s] = q;
                            sizesArr.push(s);
                            totalStock += q;
                        }
                    }
                });
            } catch(e) {
                return alert("Format incorrect. Utilisez: 40:5, 41:2");
            }

            if(sizesArr.length === 0) return alert("Aucune taille valide trouv√©e.");

            try {
                await db.collection("products").add({
                    name, category, price, sizes: sizesArr, stock: stockMap, totalStock: totalStock,
                    img: img || "https://via.placeholder.com/400", longDesc: desc, createdAt: new Date()
                });
                alert("Produit ajout√© !");
                document.querySelectorAll('.input-neo').forEach(i => { if(i.tagName !== 'SELECT') i.value = ""; });
            } catch(e) {
                alert("Erreur ajout : " + e.message);
            }
        }

        db.collection("products").orderBy("createdAt", "desc").onSnapshot(snap => {
            const list = document.getElementById('admin-product-list');
            list.innerHTML = snap.docs.map(doc => {
                const p = doc.data();
                const catName = p.category === 'street' ? 'DOMINATE THE FIELD' : 'OWN THE STREETS';
                let stockDisplay = "";
                if (p.stock && typeof p.stock === 'object') {
                    stockDisplay = Object.entries(p.stock).map(([size, qty]) => {
                        const badgeClass = qty <= 1 ? 'low-stock' : '';
                        return `<span class="size-badge ${badgeClass}">${size}: ${qty}</span>`;
                    }).join('');
                } else {
                    stockDisplay = `<span class="font-bold">Stock Global: ${p.stock || 0}</span>`;
                }

                return `
                <div class="admin-card bg-white neo-brutal-shadow flex flex-col">
                    <div class="flex gap-4 mb-4">
                        <img src="${p.img}" class="w-24 h-24 object-cover border-2 border-black">
                        <div>
                            <h4 class="font-bold uppercase text-lg leading-tight">${p.name}</h4>
                            <span class="text-xs bg-black text-[#E2A900] px-1 font-bold">${catName}</span>
                            <p class="font-bold mt-1">${p.price} DA</p>
                        </div>
                    </div>
                    <div class="bg-gray-100 p-2 border-2 border-black mb-4">
                        <p class="text-xs font-bold uppercase mb-1">Stocks :</p>
                        <div class="flex flex-wrap gap-y-1">${stockDisplay}</div>
                    </div>
                    <button onclick="deleteProduct('${doc.id}')" class="text-red-500 underline text-xs mt-auto text-left">Supprimer l'article</button>
                </div>`;
            }).join('');
        });

        // --- GESTION COMMANDES ---
        window.confirmOrder = async function(orderId) {
            if(!confirm("Confirmer la commande et d√©duire du stock ?")) return;
            try {
                const orderDoc = await db.collection("orders").doc(orderId).get();
                if (!orderDoc.exists) return alert("Commande introuvable");
                const items = orderDoc.data().items || [];

                for (const item of items) {
                    const productQuery = await db.collection("products").where("name", "==", item.name).get();
                    if (!productQuery.empty) {
                        const productDoc = productQuery.docs[0];
                        const productData = productDoc.data();
                        const sizeOrdered = item.size.toString();
                        if (productData.stock && typeof productData.stock === 'object') {
                            const currentQty = productData.stock[sizeOrdered];
                            if (currentQty > 0) {
                                const updateField = {};
                                updateField[`stock.${sizeOrdered}`] = currentQty - 1;
                                await db.collection("products").doc(productDoc.id).update(updateField);
                            }
                        }
                    }
                }
                await db.collection("orders").doc(orderId).update({ status: "Confirm√©" });
                alert("Commande valid√©e et stock d√©cr√©ment√© !");
            } catch (e) { alert("Erreur: " + e.message); }
        };

        window.rejectOrder = async function(orderId) {
            if(!confirm("Rejeter cette commande ?")) return;
            try { await db.collection("orders").doc(orderId).update({ status: "Rejet√©" }); } catch (e) { alert("Erreur : " + e.message); }
        };

        window.deleteOrder = async function(id) { 
            if(confirm("Effacer d√©finitivement ?")) {
                try { await db.collection("orders").doc(id).delete(); } catch(e) { alert("Erreur: " + e.message); }
            }
        };
        
        window.deleteProduct = async function(id) { 
            if(confirm("Supprimer l'article ?")) {
                try { await db.collection("products").doc(id).delete(); } catch(e) { alert("Erreur: " + e.message); }
            }
        };

        db.collection("orders").orderBy("date", "desc").onSnapshot(snap => {
            const list = document.getElementById('admin-orders-list');
            list.innerHTML = snap.docs.map(doc => {
                const o = doc.data();
                const isConfirmed = o.status === "Confirm√©";
                const isRejected = o.status === "Rejet√©";
                
                let statusBadge = "";
                let actions = "";

                if(isConfirmed) {
                    statusBadge = `<div class="bg-green-100 text-green-700 px-4 py-2 font-bold border-2 border-green-700">‚úÖ VALID√âE</div>`;
                    // BOUTON FACTURE AJOUT√â ICI
                    actions = `
                        <button onclick="generateInvoice('${doc.id}')" class="bg-blue-600 text-white px-3 py-1 font-bold border-2 border-black hover:bg-blue-800 mr-2">üìÑ FACTURE</button>
                        <button onclick="deleteOrder('${doc.id}')" class="text-xs underline text-gray-500">Archiver</button>
                    `;
                } else if(isRejected) {
                    statusBadge = `<div class="bg-red-100 text-red-700 px-4 py-2 font-bold border-2 border-red-700">‚ùå REJET√âE</div>`;
                    actions = `<button onclick="deleteOrder('${doc.id}')" class="text-xs underline text-gray-500">Archiver</button>`;
                } else {
                    actions = `
                        <button onclick="confirmOrder('${doc.id}')" class="bg-green-500 text-white px-4 py-2 font-bold border-2 border-black mr-2 hover:bg-green-600">ACCEPTER</button>
                        <button onclick="rejectOrder('${doc.id}')" class="bg-red-500 text-white px-4 py-2 font-bold border-2 border-black hover:bg-red-600">REJETER</button>
                    `;
                }

                const itemsHtml = (o.items || []).map(item => `
                    <div class="flex items-center gap-4 border-b border-black/10 py-2 last:border-0">
                        <img src="${item.img || 'https://via.placeholder.com/50'}" class="w-12 h-12 border-2 border-black object-cover bg-white">
                        <div><p class="font-bold text-sm">${item.name}</p><p class="text-xs">T: ${item.size} | ${item.price} DA</p></div>
                    </div>
                `).join('');

                return `
                <div class="admin-card ${isConfirmed || isRejected ? 'bg-gray-100 opacity-80' : 'bg-white'} neo-brutal-shadow transition-all duration-300">
                    <div class="flex justify-between border-b-2 border-black mb-4 pb-2">
                        <span class="heading-font text-lg">${o.client}</span>
                        <span class="font-black text-xl">${o.total} DA</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="font-bold">üìû ${o.phone}</p>
                            <p class="text-sm italic mb-2">üìç ${o.wilaya}</p>
                            <p class="text-xs opacity-50">Date: ${o.date}</p>
                        </div>
                        <div class="bg-gray-50 p-2 border-2 border-black/5">${itemsHtml || 'D√©tails manquants'}</div>
                    </div>
                    <div class="flex justify-between items-center mt-6">
                        <div class="flex gap-2 items-center">${actions}</div>
                        ${statusBadge}
                    </div>
                </div>`;
            }).join('');
        });
    </script>
</body>
</html>