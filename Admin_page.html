<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R10 Admin | Dashboard Propri√©taire</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Space+Grotesk:wght@300;400;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #E2A900; --dark: #000100; }
        body { background-color: white; color: var(--dark); font-family: 'Space Grotesk', sans-serif; }
        .neo-brutal-shadow { box-shadow: 8px 8px 0px 0px var(--dark); }
        .heading-font { font-family: 'Archivo Black', sans-serif; text-transform: uppercase; }
        .admin-card { border: 4px solid var(--dark); padding: 1.5rem; margin-bottom: 2rem; }
        .input-neo { border: 3px solid black; padding: 0.5rem; width: 100%; font-weight: bold; outline: none; margin-bottom: 1rem; }
        .sidebar { background: var(--dark); color: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .size-checkbox:checked + span { color: red; text-decoration: line-through; font-weight: bold; }
    </style>
</head>
<body class="flex min-h-screen">

    <aside class="w-64 sidebar p-6 flex flex-col border-r-4 border-black">
        <h1 class="heading-font text-2xl mb-10 text-white">R10 <span class="text-[#E2A900]">ADMIN</span></h1>
        <nav class="space-y-4">
            <button onclick="showTab('inventory')" class="w-full text-left font-bold hover:underline">üì¶ INVENTAIRE</button>
            <button onclick="showTab('orders')" class="w-full text-left font-bold hover:underline">üßæ COMMANDES</button>
            <hr class="border-gray-700">
            <a href="index.html" class="text-sm opacity-70">Voir la boutique client</a>
        </nav>
    </aside>

    <main class="flex-grow p-10">
        <section id="inventory" class="tab-content active">
            <h2 class="heading-font text-4xl mb-8">Gestion du Stock</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
                <div class="admin-card neo-brutal-shadow bg-[#E2A900]">
                    <h3 class="heading-font text-xl mb-4">Ajouter un Produit</h3>
                    
                    <label class="block font-bold">Nom du mod√®le</label>
                    <input type="text" id="p-name" class="input-neo" placeholder="Ex: R10 Gold '05">
                    
                    <label class="block font-bold">Cat√©gorie</label>
                    <select id="p-category" class="input-neo bg-white">
                        <option value="sneakers">OWN THE STREETS</option>
                        <option value="street">DOMINATE THE FIELD</option>
                    </select>

                    <label class="block font-bold">Prix (DA)</label>
                    <input type="number" id="p-price" class="input-neo" placeholder="18000">
                    
                    <label class="block font-bold">Pointures (ex: 40, 41, 42)</label>
                    <input type="text" id="p-sizes" class="input-neo" placeholder="40, 41, 42">
                    
                    <label class="block font-bold">Stock Global</label>
                    <input type="number" id="p-stock" class="input-neo" placeholder="10">
                    
                    <label class="block font-bold">URL Image</label>
                    <input type="text" id="p-img" class="input-neo" placeholder="Lien de la photo">
                    
                    <label class="block font-bold">Description</label>
                    <textarea id="p-desc" class="input-neo" rows="2"></textarea>
                    
                    <button type="button" onclick="addProduct()" class="w-full bg-black text-white p-3 font-black uppercase">Mettre en rayon</button>
                </div>

                <div class="lg:col-span-2">
                    <div id="admin-product-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </section>

        <section id="orders" class="tab-content">
            <h2 class="heading-font text-4xl mb-8">Commandes Re√ßues</h2>
            <div id="admin-orders-list" class="space-y-6"></div>
        </section>
    </main>

    <script>
        const ADMIN_PASSWORD = "123"; 
        const access = prompt("Acc√®s r√©serv√© au propri√©taire. Entrez le mot de passe :");
        
        if (access !== ADMIN_PASSWORD) {
            document.body.innerHTML = `
                <div class="flex flex-col items-center justify-center h-screen bg-red-100">
                    <h1 class="text-4xl font-black text-red-600 mb-4 heading-font">ACC√àS REFUS√â ‚õî</h1>
                    <p class="text-xl mb-6 font-bold">Mot de passe incorrect.</p>
                    <button onclick="location.reload()" class="bg-black text-white px-8 py-4 font-black border-4 border-black hover:bg-white hover:text-black transition-all neo-brutal-shadow">R√âESSAYER</button>
                </div>
            `;
            throw new Error("Mot de passe incorrect");
        }

        const firebaseConfig = {
            apiKey: "AIzaSyCrEd8zSy5bBape6ws3v7mvTavcZfhCKM8",
            authDomain: "r10-store-f6bb3.firebaseapp.com",
            projectId: "r10-store-f6bb3",
            storageBucket: "r10-store-f6bb3.firebasestorage.app",
            messagingSenderId: "154441292816",
            appId: "1:154441292816:web:2390d040a37d7052fdbe95"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
        }

        async function addProduct() {
            const name = document.getElementById('p-name').value;
            const category = document.getElementById('p-category').value;
            const price = parseInt(document.getElementById('p-price').value);
            const sizes = document.getElementById('p-sizes').value.split(',').map(s => s.trim()).filter(s => s !== "");
            const stock = parseInt(document.getElementById('p-stock').value);
            const img = document.getElementById('p-img').value;
            const desc = document.getElementById('p-desc').value;

            if(!name || !price || isNaN(stock)) return alert("Champs requis !");

            await db.collection("products").add({
                name, category, price, sizes, stock, 
                img: img || "https://via.placeholder.com/400", 
                longDesc: desc, 
                createdAt: new Date(),
                unavailableSizes: [] 
            });
            alert("Produit ajout√© !");
            document.querySelectorAll('.input-neo').forEach(i => { if(i.tagName !== 'SELECT') i.value = ""; });
        }

        async function toggleSize(docId, size, isChecked) {
            const productRef = db.collection("products").doc(docId);
            if (isChecked) {
                await productRef.update({ unavailableSizes: firebase.firestore.FieldValue.arrayUnion(size) });
            } else {
                await productRef.update({ unavailableSizes: firebase.firestore.FieldValue.arrayRemove(size) });
            }
        }

        db.collection("products").orderBy("createdAt", "desc").onSnapshot(snap => {
            const list = document.getElementById('admin-product-list');
            list.innerHTML = snap.docs.map(doc => {
                const p = doc.data();
                const stockColor = p.stock <= 2 ? 'text-red-600' : 'text-green-600';
                const catName = p.category === 'street' ? 'DOMINATE THE FIELD' : 'OWN THE STREETS';
                
                const sizesHtml = p.sizes.map(s => {
                    const isUnavailable = (p.unavailableSizes || []).includes(s);
                    return `
                        <label class="inline-flex items-center mr-3 cursor-pointer">
                            <input type="checkbox" class="size-checkbox form-checkbox h-4 w-4 text-red-600 border-2 border-black" 
                                onchange="toggleSize('${doc.id}', '${s}', this.checked)"
                                ${isUnavailable ? 'checked' : ''}>
                            <span class="ml-1 ${isUnavailable ? 'text-red-600 line-through' : ''}">${s}</span>
                        </label>
                    `;
                }).join('');

                return `
                <div class="admin-card bg-white neo-brutal-shadow flex flex-col">
                    <div class="flex gap-4">
                        <img src="${p.img}" class="w-24 h-24 object-cover border-2 border-black">
                        <div>
                            <h4 class="font-bold uppercase text-lg">${p.name}</h4>
                            <span class="text-xs bg-black text-[#E2A900] px-1 font-bold">${catName}</span>
                            <p class="font-bold mt-1">${p.price} DA</p>
                            <p class="text-sm">Stock: <span class="font-black ${stockColor}">${p.stock}</span></p>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-2 bg-gray-100 border-2 border-black">
                        <p class="text-xs font-bold mb-2 uppercase">Cochez les tailles √©puis√©es :</p>
                        <div class="flex flex-wrap">
                            ${sizesHtml}
                        </div>
                    </div>

                    <button onclick="deleteProduct('${doc.id}')" class="text-red-500 underline text-xs mt-auto pt-4 text-left">Supprimer l'article</button>
                </div>`;
            }).join('');
        });

        async function confirmOrder(orderId, items) {
            if(!confirm("Confirmer la commande ?")) return;
            await db.collection("orders").doc(orderId).update({ status: "Confirm√©" });
            for (const item of items) {
                const productQuery = await db.collection("products").where("name", "==", item.name).get();
                if (!productQuery.empty) {
                    const productDoc = productQuery.docs[0];
                    const currentStock = productDoc.data().stock;
                    if (currentStock > 0) {
                        await db.collection("products").doc(productDoc.id).update({ stock: currentStock - 1 });
                    }
                }
            }
        }

        async function rejectOrder(orderId) {
            if(!confirm("Rejeter cette commande ?")) return;
            await db.collection("orders").doc(orderId).update({ status: "Rejet√©" });
        }

        async function deleteOrder(id) { if(confirm("Effacer d√©finitivement ?")) await db.collection("orders").doc(id).delete(); }
        async function deleteProduct(id) { if(confirm("Supprimer l'article ?")) await db.collection("products").doc(id).delete(); }

        db.collection("orders").orderBy("date", "desc").onSnapshot(snap => {
            const list = document.getElementById('admin-orders-list');
            list.innerHTML = snap.docs.map(doc => {
                const o = doc.data();
                const isConfirmed = o.status === "Confirm√©";
                const isRejected = o.status === "Rejet√©";
                
                let statusBadge = "";
                let actions = "";

                if(isConfirmed) {
                    statusBadge = `<div class="bg-green-100 text-green-700 px-4 py-2 font-bold border-2 border-green-700">‚úÖ VALID√âE</div>`;
                    actions = `<button onclick="deleteOrder('${doc.id}')" class="text-xs underline text-gray-500">Archiver</button>`;
                } else if(isRejected) {
                    statusBadge = `<div class="bg-red-100 text-red-700 px-4 py-2 font-bold border-2 border-red-700">‚ùå REJET√âE</div>`;
                    actions = `<button onclick="deleteOrder('${doc.id}')" class="text-xs underline text-gray-500">Archiver</button>`;
                } else {
                    actions = `
                        <button onclick='confirmOrder("${doc.id}", ${JSON.stringify(o.items)})' class="bg-green-500 text-white px-4 py-2 font-bold border-2 border-black mr-2 hover:bg-green-600">ACCEPTER</button>
                        <button onclick='rejectOrder("${doc.id}")' class="bg-red-500 text-white px-4 py-2 font-bold border-2 border-black hover:bg-red-600">REJETER</button>
                    `;
                }

                const itemsHtml = o.items ? o.items.map(item => `
                    <div class="flex items-center gap-4 border-b border-black/10 py-2 last:border-0">
                        <img src="${item.img || 'https://via.placeholder.com/50'}" class="w-12 h-12 border-2 border-black object-cover bg-white">
                        <div><p class="font-bold text-sm">${item.name}</p><p class="text-xs">T: ${item.size} | ${item.price} DA</p></div>
                    </div>
                `).join('') : 'D√©tails manquants';

                return `
                <div class="admin-card ${isConfirmed || isRejected ? 'bg-gray-100 opacity-80' : 'bg-white'} neo-brutal-shadow transition-all duration-300">
                    <div class="flex justify-between border-b-2 border-black mb-4 pb-2">
                        <span class="heading-font text-lg">${o.client}</span>
                        <span class="font-black text-xl">${o.total} DA</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="font-bold">üìû ${o.phone}</p>
                            <p class="text-sm italic mb-2">üìç ${o.wilaya}</p>
                            <p class="text-xs opacity-50">Date: ${o.date}</p>
                        </div>
                        <div class="bg-gray-50 p-2 border-2 border-black/5">${itemsHtml}</div>
                    </div>
                    <div class="flex justify-between items-center mt-6">
                        <div class="flex gap-2">${actions}</div>
                        ${statusBadge}
                    </div>
                </div>`;
            }).join('');
        });
    </script>
</body>
</html>